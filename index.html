<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generador de emails profesionales</title>
  <style>
    :root {
      color-scheme: light;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 2rem 1rem;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #ffffff;
      color: #111111;
    }

    main {
      max-width: 840px;
      margin: 0 auto;
      display: grid;
      gap: 1rem;
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    p {
      margin: 0;
      color: #555555;
      font-size: 0.95rem;
    }

    label {
      font-size: 0.9rem;
      color: #333333;
    }

    textarea,
    input,
    button {
      width: 100%;
      border: 1px solid #d9d9d9;
      border-radius: 10px;
      padding: 0.75rem 0.85rem;
      font: inherit;
      color: inherit;
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 170px;
      line-height: 1.5;
    }

    #output {
      min-height: 220px;
      background: #fafafa;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    button {
      background: #111111;
      color: #ffffff;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s ease;
    }

    button:disabled {
      opacity: 0.7;
      cursor: default;
    }

    @media (max-width: 640px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main>
    <h1>Generador de emails profesionales</h1>
    <p>Redacta correos claros y formales en segundos.</p>

    <label for="instruction">Instrucción</label>
    <textarea id="instruction" placeholder="Escribe un correo pidiendo feedback sobre el nuevo prototipo."></textarea>

    <div class="grid">
      <div>
        <label for="senderName">Su nombre</label>
        <input id="senderName" type="text" placeholder="Tu nombre" />
      </div>
      <div>
        <label for="clientName">Nombre del cliente</label>
        <input id="clientName" type="text" placeholder="Nombre del cliente" />
      </div>
    </div>

    <button id="generateButton" type="button">Generar email</button>

    <label for="output">Email generado</label>
    <textarea id="output" readonly placeholder="Aquí aparecerá el email generado..."></textarea>
  </main>

  <script>
    const instructionEl = document.getElementById('instruction');
    const senderNameEl = document.getElementById('senderName');
    const clientNameEl = document.getElementById('clientName');
    const outputEl = document.getElementById('output');
    const generateButton = document.getElementById('generateButton');

    async function generateEmail() {
      const instruction = instructionEl.value.trim();
      const senderName = senderNameEl.value.trim();
      const clientName = clientNameEl.value.trim();

      if (!instruction || !senderName || !clientName) return;

      generateButton.disabled = true;
      generateButton.textContent = 'Generando...';
      outputEl.value = '';

      try {
        const res = await fetch('/api/email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ instruction, senderName, clientName })
        });

        if (!res.ok || !res.body) {
          outputEl.value = 'No se pudo generar el email.';
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const events = buffer.split('\n\n');
          buffer = events.pop() || '';

          for (const event of events) {
            const line = event.split('\n').find((l) => l.startsWith('data: '));
            if (!line) continue;

            try {
              const payload = JSON.parse(line.slice(6));
              if (payload.type === 'chunk' && payload.text) {
                outputEl.value += payload.text;
              }
              if (payload.type === 'error') {
                outputEl.value = payload.message || 'Error al generar el email.';
              }
            } catch {
              // ignorar evento inválido
            }
          }
        }
      } catch {
        outputEl.value = 'Error de conexión.';
      } finally {
        generateButton.disabled = false;
        generateButton.textContent = 'Generar email';
      }
    }

    generateButton.addEventListener('click', generateEmail);
  </script>
</body>
</html>
